---
name: Docker Image CI

on:
  push:
    branches: main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create config file for kaniko
        run: |
          cat <<EOF > config.json
          {
            "auths": {
              "ghcr.io": {
                "auth": "$(echo -n ${{ secrets.REGISTRY_USER }}:${{ secrets.REGISTRY_TOKEN }} | base64)"
              }
            }
          }
          EOF
          cat config.json

      - name: Build the Docker image
        run: |
          docker run \
            -v `pwd`:/workspace \
            -v `pwd`/config.json:/kaniko/.docker/config.json:ro \
            gcr.io/kaniko-project/executor:latest \
              --dockerfile=Dockerfile \
              --context dir:///workspace/ \
              --destination=https://ghcr.io/code-4-penguins/github-actions/my-python-app
            # --no-push
